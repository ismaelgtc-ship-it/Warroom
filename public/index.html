<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>warroom</title>
    <style>
      body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; }
      .row { display: flex; gap: 12px; align-items: center; }
      .card { border: 1px solid #ddd; border-radius: 10px; padding: 14px; margin-top: 14px; }
      table { width: 100%; border-collapse: collapse; }
      th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
      .pill { display: inline-block; padding: 2px 10px; border-radius: 999px; font-size: 12px; border: 1px solid #ccc; }
      .up { border-color: #2e7d32; color: #2e7d32; }
      .down { border-color: #c62828; color: #c62828; }
      code { background: #f6f8fa; padding: 2px 6px; border-radius: 6px; }
      button { padding: 10px 12px; border-radius: 10px; border: 1px solid #ddd; background: white; cursor: pointer; }
      button:active { transform: translateY(1px); }
      .muted { color: #666; font-size: 13px; }
    </style>
    <script src="./config.js"></script>
  </head>
  <body>
    <div class="row">
      <h1 style="margin:0">warroom</h1>
      <span class="muted">status dashboard</span>
    </div>

    <div class="card">
      <div class="row" style="justify-content: space-between">
        <div>
          <div class="muted">Gateway public URL</div>
          <div><code id="gw"></code></div>
        </div>
        <button id="refresh">Refresh</button>
      </div>
      <p class="muted">Uses <code>/api/core/public-status</code> (no API keys in browser).</p>
    </div>

    <div class="card">
      <h2 style="margin:0 0 12px 0">Services</h2>
      <table>
        <thead>
          <tr>
            <th>Service</th>
            <th>Status</th>
            <th>Version</th>
            <th>Last heartbeat</th>
          </tr>
        </thead>
        <tbody id="services"></tbody>
      </table>
      <div id="err" class="muted" style="margin-top:10px"></div>
    </div>

    <script>
      const cfg = window.WARROOM_CONFIG || { GATEWAY_PUBLIC_URL: "" };
      document.getElementById('gw').textContent = cfg.GATEWAY_PUBLIC_URL || "(not set)";

      function fmt(ts) {
        if (!ts) return "-";
        const d = new Date(ts);
        return Number.isNaN(d.getTime()) ? String(ts) : d.toISOString();
      }

      async function load() {
        const tbody = document.getElementById('services');
        const err = document.getElementById('err');
        tbody.innerHTML = "";
        err.textContent = "";

        try {
          const url = new URL('/api/core/public-status', cfg.GATEWAY_PUBLIC_URL).toString();
          const res = await fetch(url, { method: 'GET' });
          const json = await res.json();
          if (!json.ok) throw new Error(json.error || 'ERR');

          for (const s of (json.services || [])) {
            const tr = document.createElement('tr');
            const pill = `<span class="pill ${s.isUp ? 'up' : 'down'}">${s.isUp ? 'UP' : 'DOWN'}</span>`;
            tr.innerHTML = `
              <td><code>${s.service}</code></td>
              <td>${pill}</td>
              <td>${s.version || '-'}</td>
              <td>${fmt(s.lastHeartbeatAt)}</td>
            `;
            tbody.appendChild(tr);
          }
        } catch (e) {
          err.textContent = `Failed to load status: ${e?.message || e}`;
        }
      }

      document.getElementById('refresh').addEventListener('click', load);
      load();
      setInterval(load, 30_000);
    </script>
  </body>
</html>
